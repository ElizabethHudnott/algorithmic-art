<!DOCTYPE html>
<html>
<head>
	<title>Background Generation Test page</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" href="../img/spirograph.png">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
</head>
<body style="margin: 0; overflow: hidden;">
<div style="position: absolute; top: 0.5em; right: 0.5em; opacity: 0.8">
	<a href="https://www.patreon.com/bePatron?u=23440273" data-patreon-widget-type="become-patron-button">Become a Patron!</a><script async src="https://c6.patreon.com/becomePatronButton.bundle.js"></script>
</div>

<div class="alert alert-dark alert-dismissible fade show position-absolute" role="alert" style="top: 0.5em; left: 50%; width: 350px; margin-left: -175px !important" id="instructions">
  Controls are in the lower left corner.
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div>

<canvas id="background-canvas"></canvas>

<div class="btn-toolbar" role="toolbar" aria-label="Toolbar" style="position: absolute; bottom: 1.5em; left: 0.5em; opacity: 0.8">
	<button type="button" class="btn btn-light" id="btn-background-gen-options" data-toggle="modal" data-target="#background-gen-modal" data-backdrop="false">
		<img src="../img/gear_in.png" alt="Options" title="Set options">
	</button>
	<input id="paper-color" type="color" value="#ffffff" style="height: 32px" class="my-2" title="Change background colour">
	<button type="button" class="btn btn-light" id="btn-generate-background">
		<img src="../img/brick.png" alt="Generate" title="Generate new background">
	</button>
</div>

<div class="modal fade" id="background-gen-modal" tabindex="-1" role="dialog" aria-labelledby="background-gen-modal-label" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<form id="background-gen-form" class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="background-gen-modal-label"></h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div id="background-gen-options" class="modal-body">
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" data-dismiss="modal">Done</button>
			</div>
		</form>
	</div>
</div>

<script>
	const backgroundGenerators = new Map();
	let bgGenerator;
	let backgroundRedraw;

	function injectScript(src) {
		return new Promise(function (resolve, reject) {
			const script = document.createElement('script');
			script.async = true;
			script.src = src;
			script.addEventListener('load', resolve);
			script.addEventListener('error', () => reject('injectScript: Error loading ' + src));
			script.addEventListener('abort', () => reject('injectScript: Aborted loading ' + src));
			document.head.appendChild(script);
		});
	}

	function downloadDocument(url) {
		return new Promise(function (resolve, reject) {
			const request = new XMLHttpRequest();
			request.onload = function() {
				resolve(this.responseXML);
			}
			request.open("GET", url);
			request.responseType = "document";
			request.send();
		});
	}

	function backgroundGeneratorFactory(name) {
		let generator = backgroundGenerators.get(name);
		if (generator === undefined) {
			return injectScript(name + '.js').then(function () {
				return  backgroundGenerators.get(name);
			});
		} else {
			return new Promise(function (resolve, reject) {
				return resolve(generator);
			})
		}
	}


	const canvas = document.getElementById('background-canvas');
	function generateBackground() {
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
		progressiveBackgroundGen(bgGenerator);
	}

	function progressiveBackgroundGen(generator) {
		const redraw = generator.generate();
		backgroundRedraw = redraw;
		let done = false;
		function drawSection() {
			if (backgroundRedraw === redraw) {
				done = redraw.next().done;
				if (!done) {
					setTimeout(drawSection, 0);
				}
			}
		}
		drawSection();
	}

	function switchBackgroundGenerator(name) {
		backgroundGeneratorFactory(name).then(function (gen) {
			bgGenerator = gen;
			generateBackground();
			document.getElementById('background-gen-modal-label').innerHTML = gen.title + ' Options';
			gen.optionsDocument.then(function (optionsDoc) {
				const container = document.getElementById('background-gen-options');
				container.innerHTML = '';
				const elements = optionsDoc.body.children;
				while (elements.length > 0) {
					container.appendChild(elements[0]);
				}
			});
		});
	}

	const urlParameters = new URLSearchParams(document.location.search);
	switchBackgroundGenerator(urlParameters.get('generator'));

	document.getElementById('paper-color').addEventListener('input', function (event) {
		document.body.style.backgroundColor = this.value;
	});

	document.getElementById('btn-generate-background').addEventListener('click', generateBackground);

	setTimeout(function () {
		document.getElementById('instructions').classList.remove('show');
	}, 10000);

</script>
</body>
</html>
